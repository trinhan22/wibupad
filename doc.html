<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêang ƒë·ªçc - WibuPad</title>
    <link rel="icon" type="image/png" href="logo.png" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #0f0f0f;
            --bg-nav: #161616;
            --text-main: #cecece;
            --text-title: #ffffff;
            --primary: #FF5E62;
            --font-read: 'Merriweather', serif;
            --font-ui: 'Be Vietnam Pro', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            line-height: 1.8;
            -webkit-font-smoothing: antialiased;
        }

        /* --- TOP NAVIGATION --- */
        .reading-header {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 0 5%;
            z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.05);
            justify-content: space-between;
        }
        .back-link { color: #888; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.3s; }
        .back-link:hover { color: var(--primary); }
        .story-nav-title { font-weight: 700; color: #fff; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50%; }

        /* --- READING CANVAS --- */
        .reading-container {
            max-width: 800px; margin: 100px auto 150px; padding: 0 25px;
            animation: fadeIn 0.8s ease;
        }
        
        /* üî• ƒê√£ x√≥a .chapter-label */

        /* üî• C·∫≠p nh·∫≠t m√†u cho ti√™u ƒë·ªÅ ch√≠nh */
        .chapter-title { 
            font-size: 2.2rem; 
            font-weight: 800; 
            color: var(--primary); /* ƒê·ªïi m√†u th√†nh ƒë·ªè */
            line-height: 1.3; 
            margin-bottom: 40px; 
        }
        
        .chapter-content { 
            font-family: var(--font-read); 
            font-size: 1.25rem; 
            color: var(--text-main);
            text-align: justify;
        }
        .chapter-content p { margin-bottom: 25px; }

        /* --- BOTTOM BAR --- */
        .nav-bottom {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: var(--bg-nav); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center; gap: 30px;
            z-index: 1000;
        }
        .btn-nav {
            background: transparent; border: 1px solid #333; color: #fff;
            padding: 8px 25px; border-radius: 50px; cursor: pointer; transition: 0.3s;
            font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
        }
        .btn-nav:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); background: rgba(255, 94, 98, 0.05); }
        .btn-nav:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-main-nav { background: var(--primary); border-color: var(--primary); }
        .btn-main-nav:hover { background: #ff4757; }

        /* --- UI UTILS --- */
        #loading { position: fixed; inset: 0; background: #0a0a0a; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            .chapter-title { font-size: 1.7rem; }
            .chapter-content { font-size: 1.15rem; }
            .btn-nav span { display: none; }
            .btn-nav { padding: 12px 20px; }
        }
    </style>
</head>
<body>

    <div id="loading">
        <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: #FF5E62;"></i>
    </div>

    <header class="reading-header">
        <a href="#" id="backBtn" class="back-link">
            <i class="fas fa-chevron-left"></i> <span>Quay l·∫°i</span>
        </a>
        <div class="story-nav-title" id="navStoryTitle">ƒêang t·∫£i t√™n truy·ªán...</div>
        <div style="width: 80px; text-align: right;">
            <i class="fas fa-font" style="cursor:pointer; color:#666;"></i>
        </div>
    </header>

    <main class="reading-container">
        <h1 class="chapter-title" id="chapTitle">ƒêang t·∫£i n·ªôi dung...</h1>
        
        <div class="chapter-content" id="chapContent">
        </div>
    </main>

    <nav class="nav-bottom">
        <button id="prevBtn" class="btn-nav" disabled>
            <i class="fas fa-arrow-left"></i> <span>Ch∆∞∆°ng tr∆∞·ªõc</span>
        </button>
        
        <button id="tocBtn" class="btn-nav">
            <i class="fas fa-list"></i>
        </button>

        <button id="nextBtn" class="btn-nav" disabled>
            <span>Ch∆∞∆°ng ti·∫øp</span> <i class="fas fa-arrow-right"></i>
        </button>
    </nav>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config Firebase
        const firebaseConfig = { apiKey: "AIzaSyAT6SnKojUmsisDhnuEtsL3H59NwrhZxDc", authDomain: "hopphim-29e1c.firebaseapp.com", projectId: "hopphim-29e1c", storageBucket: "hopphim-29e1c.firebasestorage.app", messagingSenderId: "1076044580405", appId: "1:1076044580405:web:a3485f8533604f305e537c", measurementId: "G-6RT4CX2NR0" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('storyId');
        const chapId = urlParams.get('chapId');

        let allChapterIds = [];

        onAuthStateChanged(auth, (user) => {
            if (user) window.currentUser = user;
        });

        async function initReader() {
            if (!storyId || !chapId) { window.location.href = 'index.html'; return; }

            try {
                // 1. L·∫•y th√¥ng tin truy·ªán
                const storySnap = await getDoc(doc(db, "stories", storyId));
                if (storySnap.exists()) {
                    const storyData = storySnap.data();
                    document.getElementById('navStoryTitle').innerText = storyData.title;
                    document.getElementById('backBtn').href = `doc-truyen.html?id=${storyId}`;
                    
                    // üî• G·ªåI H√ÄM TƒÇNG VIEW
                    incrementViewCount(storyId);
                }

                // 2. L·∫•y danh s√°ch ch∆∞∆°ng ƒë·ªÉ l√†m ƒëi·ªÅu h∆∞·ªõng
                const q = query(collection(db, "stories", storyId, "chapters"), orderBy("createdAt", "asc"));
                const listSnap = await getDocs(q);
                allChapterIds = listSnap.docs.map(d => d.id);
                
                const currentIndex = allChapterIds.indexOf(chapId);
                const chapterNumber = currentIndex + 1;

                // 3. L·∫•y n·ªôi dung ch∆∞∆°ng hi·ªán t·∫°i
                const chapSnap = await getDoc(doc(db, "stories", storyId, "chapters", chapId));
                if (chapSnap.exists()) {
                    const chapData = chapSnap.data();

                    // Hi·ªÉn th·ªã UI
                    document.title = `${chapData.title} - WibuPad`;
                    document.getElementById('chapTitle').innerText = chapData.title;
                    document.getElementById('chapContent').innerHTML = chapData.content;

                    setupNavigation(currentIndex);
                    updateUserProgress(chapterNumber);
                }

                document.getElementById('loading').style.display = 'none';
                window.scrollTo(0, 0);

            } catch (e) { 
                console.error("L·ªói tr√¨nh ƒë·ªçc:", e); 
                document.getElementById('loading').innerHTML = '<p style="color:white;">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>';
            }
        }

        // üî• H√ÄM M·ªöI: ƒê√£ t·∫°m t·∫Øt ch·ªëng spam ƒë·ªÉ b·∫°n d·ªÖ test
        async function incrementViewCount(id) {
            // üëá Khi n√†o test xong (F5 th·∫•y s·ªë nh·∫£y), b·∫°n x√≥a d·∫•u // ·ªü 2 d√≤ng d∆∞·ªõi ƒë·ªÉ b·∫≠t l·∫°i ch·ªëng spam nh√©:
            // const viewSessionKey = `viewed_${id}_${chapId}`;
            // if (sessionStorage.getItem(viewSessionKey)) { console.log("ƒê√£ t√≠nh view r·ªìi"); return; }

            try {
                const storyRef = doc(db, "stories", id);
                await updateDoc(storyRef, {
                    views: increment(1) 
                });
                
                // üëá X√≥a d·∫•u // ·ªü d√≤ng d∆∞·ªõi ƒë·ªÉ b·∫≠t l·∫°i ch·ªëng spam
                // sessionStorage.setItem(viewSessionKey, "true");
                
                console.log("‚úÖ ƒê√£ c·ªông 1 view th√†nh c√¥ng tr√™n Firebase!");
            } catch (error) {
                console.error("‚ùå L·ªói khi tƒÉng view:", error);
                // N·∫øu b√°o l·ªói ƒë·ªè ·ªü ƒë√¢y, 100% l√† do Firebase Security Rules c·ªßa b·∫°n ƒëang ch·∫∑n ng∆∞·ªùi ƒë·ªçc s·ª≠a data.
            }
        }

        function setupNavigation(index) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (index > 0) {
                prevBtn.disabled = false;
                prevBtn.onclick = () => { window.location.href = `doc.html?storyId=${storyId}&chapId=${allChapterIds[index - 1]}`; };
            } else {
                prevBtn.disabled = true;
            }

            if (index < allChapterIds.length - 1) {
                nextBtn.disabled = false;
                nextBtn.classList.add('btn-main-nav');
                nextBtn.onclick = () => { window.location.href = `doc.html?storyId=${storyId}&chapId=${allChapterIds[index + 1]}`; };
            } else {
                nextBtn.disabled = true;
                nextBtn.classList.remove('btn-main-nav');
            }
            
            document.getElementById('tocBtn').onclick = () => { window.location.href = `doc-truyen.html?id=${storyId}`; };
        }

        async function updateUserProgress(chapNum) {
            if (!auth.currentUser) return;
            try {
                const userRef = doc(db, "users", auth.currentUser.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    let history = userSnap.data().history || [];
                    let foundIndex = history.findIndex(item => item.id === storyId);
                    
                    if (foundIndex !== -1) {
                        history[foundIndex].lastChapter = chapNum;
                        history[foundIndex].updatedAt = new Date().toISOString();
                    } else {
                        const storyTitle = document.getElementById('navStoryTitle').innerText || "Truy·ªán ƒëang ƒë·ªçc";
                        history.unshift({
                            id: storyId,
                            title: storyTitle, 
                            lastChapter: chapNum,
                            updatedAt: new Date().toISOString()
                        });
                    }
                    await updateDoc(userRef, { history: history });
                }
            } catch (e) { console.error("L·ªói l∆∞u ti·∫øn ƒë·ªô:", e); }
        }

        window.addEventListener('load', initReader);
    </script>
</body>
</html>