<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêang ƒë·ªçc - WibuPad</title>
    <link rel="icon" type="image/png" href="logo.png" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #0f0f0f;
            --bg-nav: #161616;
            --text-main: #cecece;
            --text-title: #ffffff;
            --primary: #FF5E62;
            --font-read: 'Merriweather', serif;
            --font-ui: 'Be Vietnam Pro', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            line-height: 1.8;
            -webkit-font-smoothing: antialiased;
        }

        /* --- TOP NAVIGATION --- */
        .reading-header {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 0 5%;
            z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.05);
            justify-content: space-between;
        }
        .back-link { color: #888; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.3s; }
        .back-link:hover { color: var(--primary); }
        .story-nav-title { font-weight: 700; color: #fff; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50%; }

        /* --- READING CANVAS --- */
        .reading-container {
            max-width: 800px; margin: 100px auto 150px; padding: 0 25px;
            animation: fadeIn 0.8s ease;
        }
        
        .chapter-title { 
            font-size: 2.2rem; 
            font-weight: 800; 
            color: var(--primary); 
            line-height: 1.3; 
            margin-bottom: 40px; 
        }
        
        .chapter-content { 
            font-family: var(--font-read); 
            font-size: 1.25rem; 
            color: var(--text-main);
            text-align: justify;
            white-space: pre-wrap; /* Gi·ªØ ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng c·ªßa vƒÉn b·∫£n */
        }
        
        /* --- BOTTOM BAR --- */
        .nav-bottom {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: var(--bg-nav); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center; gap: 30px;
            z-index: 1000;
        }
        .btn-nav {
            background: transparent; border: 1px solid #333; color: #fff;
            padding: 8px 25px; border-radius: 50px; cursor: pointer; transition: 0.3s;
            font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
        }
        .btn-nav:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); background: rgba(255, 94, 98, 0.05); }
        .btn-nav:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-main-nav { background: var(--primary); border-color: var(--primary); }
        .btn-main-nav:hover { background: #ff4757; }

        /* --- UI UTILS --- */
        #loading { position: fixed; inset: 0; background: #0a0a0a; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            .chapter-title { font-size: 1.7rem; margin-bottom: 20px; }
            .chapter-content { font-size: 1.15rem; line-height: 1.6; }
            .btn-nav span { display: none; } /* ·∫®n ch·ªØ tr√™n mobile, ch·ªâ hi·ªán icon */
            .btn-nav { padding: 12px 20px; }
            .reading-container { padding: 0 20px; margin-top: 80px; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF5E62; }
    </style>
</head>
<body>

    <div id="loading">
        <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: #FF5E62;"></i>
    </div>

    <header class="reading-header">
        <a href="#" id="backBtn" class="back-link">
            <i class="fas fa-chevron-left"></i> <span>Quay l·∫°i</span>
        </a>
        <div class="story-nav-title" id="navStoryTitle">ƒêang t·∫£i...</div>
        <div style="width: 80px; text-align: right;">
            <i class="fas fa-font" style="cursor:pointer; color:#666;"></i>
        </div>
    </header>

    <main class="reading-container">
        <h1 class="chapter-title" id="chapTitle"></h1>
        <div class="chapter-content" id="chapContent"></div>
    </main>

    <nav class="nav-bottom">
        <button id="prevBtn" class="btn-nav" disabled>
            <i class="fas fa-arrow-left"></i> <span>Ch∆∞∆°ng tr∆∞·ªõc</span>
        </button>
        
        <button id="tocBtn" class="btn-nav">
            <i class="fas fa-list"></i>
        </button>

        <button id="nextBtn" class="btn-nav" disabled>
            <span>Ch∆∞∆°ng ti·∫øp</span> <i class="fas fa-arrow-right"></i>
        </button>
    </nav>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        // üî• Import ƒë·∫ßy ƒë·ªß c√¥ng c·ª•, ƒë·∫∑c bi·ªát l√† 'increment'
        import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config Firebase
        const firebaseConfig = { apiKey: "AIzaSyAT6SnKojUmsisDhnuEtsL3H59NwrhZxDc", authDomain: "hopphim-29e1c.firebaseapp.com", projectId: "hopphim-29e1c", storageBucket: "hopphim-29e1c.firebasestorage.app", messagingSenderId: "1076044580405", appId: "1:1076044580405:web:a3485f8533604f305e537c", measurementId: "G-6RT4CX2NR0" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('storyId');
        const chapId = urlParams.get('chapId');

        let allChapterIds = [];
        let currentStoryData = null; // Bi·∫øn quan tr·ªçng ƒë·ªÉ l∆∞u info truy·ªán cho l·ªãch s·ª≠

        // --- 1. AUTH CHECK ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                // N·∫øu trang ƒë√£ t·∫£i xong content m√† gi·ªù m·ªõi c√≥ user, th√¨ l∆∞u l·∫°i l·ªãch s·ª≠ l·∫ßn n·ªØa cho ch·∫Øc
                if (currentStoryData) {
                    // L·∫•y s·ªë ch∆∞∆°ng hi·ªán t·∫°i t·ª´ URL ho·∫∑c m·∫£ng (logic ƒë∆°n gi·∫£n)
                    const idx = allChapterIds.indexOf(chapId);
                    if(idx !== -1) updateUserProgress(idx + 1);
                }
            }
        });

        // --- 2. KH·ªûI T·∫†O TR√åNH ƒê·ªåC ---
        async function initReader() {
            if (!storyId || !chapId) { window.location.href = 'index.html'; return; }

            try {
                // A. TƒÇNG VIEW NGAY L·∫¨P T·ª®C (Ch·∫°y ng·∫ßm, kh√¥ng ch·ªù)
                incrementViewCount(storyId);

                // B. L·∫•y th√¥ng tin truy·ªán (ƒê·ªÉ hi·ªÉn th·ªã Header & L∆∞u l·ªãch s·ª≠)
                const storySnap = await getDoc(doc(db, "stories", storyId));
                if (storySnap.exists()) {
                    currentStoryData = storySnap.data();
                    
                    document.getElementById('navStoryTitle').innerText = currentStoryData.title;
                    document.getElementById('backBtn').href = `doc-truyen.html?id=${storyId}`;
                } else {
                    alert("Truy·ªán kh√¥ng t·ªìn t·∫°i!");
                    window.location.href = 'index.html';
                    return;
                }

                // C. L·∫•y danh s√°ch ch∆∞∆°ng (ƒê·ªÉ l√†m ƒëi·ªÅu h∆∞·ªõng Tr∆∞·ªõc/Sau)
                const q = query(collection(db, "stories", storyId, "chapters"), orderBy("createdAt", "asc"));
                const listSnap = await getDocs(q);
                allChapterIds = listSnap.docs.map(d => d.id);
                
                const currentIndex = allChapterIds.indexOf(chapId);
                const chapterNumber = currentIndex + 1; // S·ªë th·ª© t·ª± ch∆∞∆°ng (VD: Ch∆∞∆°ng 1)

                // D. L·∫•y n·ªôi dung ch∆∞∆°ng hi·ªán t·∫°i
                const chapSnap = await getDoc(doc(db, "stories", storyId, "chapters", chapId));
                if (chapSnap.exists()) {
                    const chapData = chapSnap.data();

                    // C·∫≠p nh·∫≠t giao di·ªán
                    document.title = `${chapData.title} - ${currentStoryData.title}`; 
                    document.getElementById('chapTitle').innerText = chapData.title;
                    document.getElementById('chapContent').innerHTML = chapData.content;

                    // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÅu h∆∞·ªõng
                    setupNavigation(currentIndex);
                    
                    // L∆∞u v√†o l·ªãch s·ª≠ ƒë·ªçc
                    updateUserProgress(chapterNumber);
                }

                // T·∫Øt loading
                document.getElementById('loading').style.display = 'none';
                window.scrollTo(0, 0);

            } catch (e) { 
                console.error("L·ªói tr√¨nh ƒë·ªçc:", e); 
                document.getElementById('loading').innerHTML = '<p style="color:white;">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>';
            }
        }

        // --- 3. TƒÇNG VIEW (C·ªòNG CON M·∫ÆT) ---
        async function incrementViewCount(id) {
            const viewSessionKey = `viewed_${id}_${chapId}`;
            
            // üëá CH·∫æ ƒê·ªò TEST: ƒêang comment d√≤ng d∆∞·ªõi ƒë·ªÉ F5 l√† tƒÉng view. 
            // Khi n√†o ch·∫°y th·∫≠t th√¨ b·ªè comment d√≤ng n√†y ƒë·ªÉ ch·∫∑n spam nh√©!
            // if (sessionStorage.getItem(viewSessionKey)) return;

            try {
                const storyRef = doc(db, "stories", id);
                
                // L·ªánh n√†y c·ªông tr·ª±c ti·∫øp v√†o Database
                await updateDoc(storyRef, { 
                    views: increment(1) 
                });
                
                // ƒê√°nh d·∫•u ƒë√£ xem trong phi√™n n√†y
                sessionStorage.setItem(viewSessionKey, "true");
                console.log("‚úÖ ƒê√£ c·ªông +1 View th√†nh c√¥ng!");
            } catch (error) {
                console.error("‚ùå L·ªói tƒÉng view:", error);
            }
        }

        // --- 4. ƒêI·ªÄU H∆Ø·ªöNG CH∆Ø∆†NG (PREV / NEXT) ---
        function setupNavigation(index) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (index > 0) {
                prevBtn.disabled = false;
                prevBtn.onclick = () => window.location.href = `doc.html?storyId=${storyId}&chapId=${allChapterIds[index - 1]}`;
            } else {
                prevBtn.disabled = true;
            }

            if (index < allChapterIds.length - 1) {
                nextBtn.disabled = false;
                nextBtn.classList.add('btn-main-nav');
                nextBtn.onclick = () => window.location.href = `doc.html?storyId=${storyId}&chapId=${allChapterIds[index + 1]}`;
            } else {
                nextBtn.disabled = true;
                nextBtn.classList.remove('btn-main-nav');
            }
            
            document.getElementById('tocBtn').onclick = () => window.location.href = `doc-truyen.html?id=${storyId}`;
        }

        // --- 5. L∆ØU L·ªäCH S·ª¨ ƒê·ªåC (LOGIC CH·ªêNG TR√ôNG & ƒê·∫®Y L√äN ƒê·∫¶U) ---
        async function updateUserProgress(chapNum) {
            // Ch·ªâ l∆∞u khi ƒë√£ c√≥ user v√† ƒë√£ t·∫£i xong info truy·ªán
            if (!auth.currentUser && !window.currentUser) return;
            if (!currentStoryData) return;
            
            try {
                const uid = auth.currentUser ? auth.currentUser.uid : window.currentUser.uid;
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);
                
                let history = [];
                if (userSnap.exists()) {
                    history = userSnap.data().history || [];
                }

                // 1. L·ªçc b·ªè truy·ªán n√†y ra kh·ªèi danh s√°ch c≈© (ƒë·ªÉ tr√°nh b·ªã tr√πng 2 d√≤ng)
                const newHistory = history.filter(item => item.id !== storyId);

                // 2. T·∫°o object truy·ªán m·ªõi nh·∫•t v·ªõi th√¥ng tin c·∫≠p nh·∫≠t
                const readingItem = {
                    id: storyId,
                    title: currentStoryData.title,
                    cover: currentStoryData.cover,
                    lastChapter: chapNum, // L∆∞u s·ªë ch∆∞∆°ng v·ª´a ƒë·ªçc
                    totalChapter: currentStoryData.chapterCount || 0,
                    addedAt: new Date().toISOString()
                };

                // 3. Ch√®n l√™n ƒë·∫ßu danh s√°ch (Recent)
                newHistory.unshift(readingItem);

                // 4. Gi·ªõi h·∫°n ch·ªâ l∆∞u 50 truy·ªán g·∫ßn nh·∫•t ƒë·ªÉ nh·∫π DB
                if (newHistory.length > 50) newHistory.pop();

                // 5. Ghi v√†o Database
                if (userSnap.exists()) {
                    await updateDoc(userRef, { history: newHistory });
                } else {
                    await setDoc(userRef, { history: newHistory });
                }
                
                console.log("üìö ƒê√£ l∆∞u l·ªãch s·ª≠ ƒë·ªçc: Chap " + chapNum);

            } catch (e) { 
                console.error("L·ªói l∆∞u ti·∫øn ƒë·ªô:", e); 
            }
        }

        // Kh·ªüi ch·∫°y
        window.addEventListener('load', initReader);
    </script>
</body>
</html>