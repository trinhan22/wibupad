<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn - WibuPad Studio</title>

    <meta property="og:title" content="WibuPad - ƒê·ªçc Truy·ªán ƒê·ªânh Cao" />
    <meta property="og:description" content="N·ªÅn t·∫£ng ƒë·ªçc v√† s√°ng t√°c truy·ªán ch·ªØ h√†ng ƒë·∫ßu." />
    <link rel="icon" type="image/png" href="logo.png" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* =========================================
           1. CORE SYSTEM & VARIABLES
           ========================================= */
        :root {
            --bg-body: #09090b;
            --bg-card: #18181b;
            --bg-card-hover: #27272a;
            --primary: #FF5E62;
            --primary-glow: rgba(255, 94, 98, 0.4);
            --primary-gradient: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);
            --glass-bg: rgba(24, 24, 27, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --font-main: 'Be Vietnam Pro', sans-serif;
            --radius-md: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            overflow-x: hidden; 
            line-height: 1.6;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF5E62; }

        /* =========================================
           2. HEADER (GLASS EFFECT)
           ========================================= */
        header {
            position: fixed; top: 0; width: 100%; height: 75px; padding: 0 4%;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; 
            background: rgba(9, 9, 11, 0.8); 
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--glass-border);
        }

        .logo-studio { display: flex; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; }
        .logo-studio img { height: 40px; width: auto; object-fit: contain; }
        .logo-studio .brand { 
            font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px;
            background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }

        .user-nav { display: flex; align-items: center; gap: 20px; }
        .btn-home {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted);
            padding: 8px 18px; border-radius: 50px; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px;
        }
        .btn-home:hover { border-color: var(--primary); color: #fff; background: rgba(255, 94, 98, 0.05); }
        .user-avatar { 
            width: 42px; height: 42px; border-radius: 50%; 
            border: 2px solid transparent; 
            background-image: linear-gradient(var(--bg-body), var(--bg-body)), var(--primary-gradient);
            background-origin: border-box; background-clip: content-box, border-box;
            cursor: pointer; object-fit: cover; transition: var(--transition); 
        }
        .user-avatar:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--primary-glow); }

        /* =========================================
           3. DASHBOARD CONTAINER
           ========================================= */
        .container { max-width: 1280px; margin: 110px auto 60px; padding: 0 24px; }

        .welcome-section { margin-bottom: 50px; animation: slideUp 0.5s ease-out; }
        .welcome-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 8px; color: #fff; letter-spacing: -1px; }
        .welcome-date { color: var(--text-muted); font-size: 1.05rem; }

        /* --- STATS GRID --- */
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 24px; margin-bottom: 60px; animation: slideUp 0.6s ease-out; 
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--glass-border);
            padding: 30px; border-radius: var(--radius-lg); 
            display: flex; align-items: center; gap: 24px;
            transition: var(--transition); position: relative; overflow: hidden;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            border-color: rgba(255, 94, 98, 0.3); 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); 
        }
        .stat-card::after {
            content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100%;
            background: linear-gradient(to left, rgba(255,255,255,0.03), transparent);
            pointer-events: none;
        }
        .stat-icon { 
            width: 64px; height: 64px; border-radius: 18px; 
            background: rgba(255, 94, 98, 0.1); color: var(--primary); 
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem; 
            box-shadow: 0 8px 16px -4px rgba(255, 94, 98, 0.2);
        }
        .stat-info h3 { font-size: 2.2rem; font-weight: 800; margin: 0; line-height: 1; color: #fff; letter-spacing: -1px; }
        .stat-info p { margin: 6px 0 0; color: var(--text-muted); font-size: 0.95rem; font-weight: 500; }

        /* =========================================
           4. STORIES LIST & CARDS
           ========================================= */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .section-title { font-size: 1.8rem; font-weight: 700; color: #fff; letter-spacing: -0.5px; }
        
        .btn-create {
            background: var(--primary-gradient); color: #fff; border: none; padding: 12px 28px;
            border-radius: 50px; font-weight: 700; font-size: 0.95rem; cursor: pointer; 
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 8px 20px -4px var(--primary-glow); transition: var(--transition);
        }
        .btn-create:hover { transform: translateY(-2px); box-shadow: 0 12px 25px -5px var(--primary-glow); filter: brightness(1.1); }

        .stories-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(440px, 1fr)); 
            gap: 24px; 
        }

        .story-card {
            background: var(--bg-card); border: 1px solid var(--glass-border); 
            border-radius: var(--radius-lg); padding: 22px;
            display: flex; gap: 24px; position: relative; overflow: hidden;
            transition: var(--transition);
        }
        .story-card:hover {
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
        }
        
        .story-card::before {
            content: ''; position: absolute; inset: 0; 
            background: linear-gradient(to right, rgba(255, 94, 98, 0.03), transparent);
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .story-card:hover::before { opacity: 1; }

        .card-poster {
            width: 120px; aspect-ratio: 2/3; border-radius: 12px; object-fit: cover;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); flex-shrink: 0; transition: 0.4s;
        }
        .story-card:hover .card-poster { transform: scale(1.03); }

        .card-body { flex: 1; display: flex; flex-direction: column; justify-content: space-between; position: relative; z-index: 2; min-width: 0; }
        
        .badge-group { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .card-status, .card-cat {
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            padding: 4px 10px; border-radius: 6px; white-space: nowrap;
        }
        .status-draft { color: #fbbf24; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); }
        .status-published { color: #34d399; background: rgba(52, 211, 153, 0.1); border: 1px solid rgba(52, 211, 153, 0.2); }
        .card-cat { color: #60a5fa; background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.2); }

        .card-title {
            font-size: 1.25rem; font-weight: 700; color: #fff; line-height: 1.4;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            margin-bottom: 8px;
        }

        .card-stats {
            display: flex; align-items: center; gap: 15px; padding: 12px 0;
            border-top: 1px solid rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 15px; flex-wrap: wrap; 
        }
        .stat-item { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; font-weight: 500; white-space: nowrap; }
        .stat-item i { color: #71717a; }

        .card-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-icon-text {
            padding: 8px 14px; border-radius: 10px; font-weight: 600; font-size: 0.85rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
            flex: 1 1 auto; min-width: 90px; white-space: nowrap;
        }

        .btn-delete { flex: 0 0 auto !important; width: 42px; padding: 0 !important; }
        
        .btn-write { background: #fff; color: #000; border-color: #fff; }
        .btn-write:hover { background: #e4e4e7; border-color: #e4e4e7; }
        .btn-edit { background: rgba(168, 85, 247, 0.1); color: #c084fc; border-color: rgba(168, 85, 247, 0.2); }
        .btn-edit:hover { background: #a855f7; color: #fff; border-color: #a855f7; }
        .btn-publish { background: rgba(52, 211, 153, 0.1); color: #34d399; border-color: rgba(52, 211, 153, 0.2); }
        .btn-publish:hover { background: #10b981; color: #fff; border-color: #10b981; }
        .btn-unpublish { background: rgba(251, 191, 36, 0.1); color: #fbbf24; border-color: rgba(251, 191, 36, 0.2); }
        .btn-unpublish:hover { background: #f59e0b; color: #fff; border-color: #f59e0b; }
        .btn-delete { background: rgba(244, 63, 94, 0.1); color: #fb7185; border-color: rgba(244, 63, 94, 0.2); }
        .btn-delete:hover { background: #f43f5e; color: #fff; border-color: #f43f5e; }

        .empty-state { 
            grid-column: 1/-1; text-align: center; padding: 80px 0; 
            border: 2px dashed var(--glass-border); border-radius: var(--radius-lg); 
            color: var(--text-muted); background: rgba(255,255,255,0.01);
        }
        .empty-icon { font-size: 3.5rem; margin-bottom: 20px; color: #27272a; }

        /* =========================================
           5. MODAL & FORM 
           ========================================= */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; 
            display: none; justify-content: center; align-items: center; 
            backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-box { 
            background: #18181b; width: 600px; max-width: 90%; 
            padding: 40px; border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        .modal-title { font-size: 1.8rem; font-weight: 800; color: #fff; margin-bottom: 30px; letter-spacing: -0.5px; }
        
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; color: #d4d4d8; margin-bottom: 10px; font-weight: 600; font-size: 0.95rem; }
        .form-control { 
            width: 100%; padding: 14px 16px; 
            background: #27272a; border: 1px solid transparent; 
            border-radius: 12px; color: #fff; transition: 0.3s; font-size: 1rem; 
            font-family: var(--font-main);
        }
        .form-control:focus { 
            background: #09090b; border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(255, 94, 98, 0.15); 
        }
        
        /* Modal Buttons */
        .modal-actions { display: flex; gap: 16px; margin-top: 40px; }
        .btn-cancel { 
            flex: 1; background: #27272a; color: #fff; padding: 14px; 
            border-radius: 50px; font-weight: 700; border: none; cursor: pointer; transition: 0.2s;
        }
        .btn-cancel:hover { background: #3f3f46; }
        .btn-confirm-modal { 
            flex: 2; background: var(--primary-gradient); color: #fff; padding: 14px; 
            border-radius: 50px; font-weight: 700; border: none; cursor: pointer; 
            transition: 0.2s; box-shadow: 0 10px 20px -5px var(--primary-glow);
        }
        .btn-confirm-modal:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-confirm-modal:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Toast */
        #toast-container { position: fixed; top: 30px; right: 30px; z-index: 10000; pointer-events: none; }
        .toast { 
            background: rgba(24, 24, 27, 0.9); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-left: 4px solid var(--primary); 
            color: #fff; padding: 16px 24px; border-radius: 12px; margin-bottom: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.4s; 
            font-weight: 600; display: flex; align-items: center; gap: 12px; pointer-events: auto;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .stories-grid { grid-template-columns: 1fr; } 
            .logo-studio .brand { display: none; }
            .story-card { flex-direction: column; } 
            .card-poster { width: 100%; aspect-ratio: 21/9; } 
        }

        /* --- KHO·∫¢NG CH·ª®A UPLOAD ·∫¢NH --- */
        .upload-area {
            display: flex; gap: 20px; align-items: flex-start;
            background: #27272a; padding: 15px; border-radius: 12px; border: 1px dashed var(--glass-border);
        }
        .preview-img {
            width: 100px; aspect-ratio: 2/3; object-fit: cover;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            background: #000; border: 1px solid #444;
        }
        .upload-controls { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 10px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-btn {
            border: 1px solid var(--primary); color: var(--primary); background: rgba(255,94,98,0.1);
            padding: 8px 15px; border-radius: 8px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .file-input-wrapper:hover .file-input-btn { background: var(--primary); color: #fff; }
        .file-input-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }

        /* üî• CSS CHO T√çNH NƒÇNG HASHTAG (M·ªöI) üî• */
        .tags-container {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
        }
        .tag-badge {
            background: rgba(255, 94, 98, 0.15); color: var(--primary);
            border: 1px solid rgba(255, 94, 98, 0.3); padding: 5px 12px;
            border-radius: 50px; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .tag-badge i { 
            cursor: pointer; opacity: 0.7; font-size: 0.8rem;
        }
        .tag-badge i:hover { opacity: 1; color: #fff; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <header>
        <a href="/" class="logo-studio">
            <img src="logo.png" alt="WibuPad">
            <span class="brand">WIBUPAD <span style="font-weight:300; opacity:0.7;">STUDIO</span></span>
        </a>
        <div class="user-nav">
            <button class="btn-home" onclick="window.location.href='/'">
                <i class="fas fa-external-link-alt"></i> Trang ch·ªß
            </button>
            <img id="userAvatar" src="" class="user-avatar" onclick="window.location.href='profile.html'">
        </div>
    </header>

    <main class="container">
        <div class="welcome-section">
            <h1 class="welcome-title">Xin ch√†o, <span id="userName" style="background: linear-gradient(135deg, #FF9966, #FF5E62); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">T√°c gi·∫£</span>!</h1>
            <p class="welcome-date" id="currentDate">H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi ƒë·ªÉ s√°ng t√°c.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-book-open"></i></div>
                <div class="stat-info">
                    <h3><span id="statTotal">0</span></h3>
                    <p>T√°c ph·∫©m</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(96, 165, 250, 0.1); color: #60a5fa;"><i class="fas fa-eye"></i></div>
                <div class="stat-info">
                    <h3><span id="statViews">0</span></h3>
                    <p>T·ªïng l∆∞·ª£t ƒë·ªçc</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(52, 211, 153, 0.1); color: #34d399;"><i class="fas fa-pen-fancy"></i></div>
                <div class="stat-info">
                    <h3><span id="statChapters">0</span></h3>
                    <p>Ch∆∞∆°ng ƒë√£ vi·∫øt</p>
                </div>
            </div>
        </div>

        <div class="section-header">
            <div class="section-title">Qu·∫£n l√Ω t√°c ph·∫©m</div>
            <button class="btn-create" onclick="openCreateModal()">
                <i class="fas fa-plus"></i> Truy·ªán m·ªõi
            </button>
        </div>

        <div id="loading" style="text-align: center; padding: 60px; color: #52525b;">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 2.5rem;"></i>
        </div>

        <div class="stories-grid" id="storiesList">
            </div>
    </main>

    <div id="createModal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="modal-title">Th√¥ng tin t√°c ph·∫©m</h2>
            
            <div class="form-group">
                <label>T√™n truy·ªán</label>
                <input type="text" id="storyTitle" class="form-control" placeholder="Nh·∫≠p t√™n t√°c ph·∫©m ·∫•n t∆∞·ª£ng...">
            </div>
            
            <div class="form-group">
                <label>Th·ªÉ lo·∫°i</label>
                <select id="storyCategory" class="form-control">
                    <option value="" disabled selected>Ch·ªçn th·ªÉ lo·∫°i ch√≠nh...</option>
                    <option value="Ti√™n Hi·ªáp">Ti√™n Hi·ªáp</option>
                    <option value="Ng√¥n T√¨nh">Ng√¥n T√¨nh</option>
                    <option value="Linh D·ªã">Linh D·ªã</option>
                    <option value="Khoa Huy·ªÖn">Khoa Huy·ªÖn</option>
                    <option value="H√†nh ƒê·ªông">H√†nh ƒê·ªông</option>
                    <option value="ƒê√¥ Th·ªã">ƒê√¥ Th·ªã</option>
                    <option value="Huy·ªÅn Huy·ªÖn">Huy·ªÅn Huy·ªÖn</option>
                    <option value="D·ªã Gi·ªõi">D·ªã Gi·ªõi</option>
                    <option value="Trinh Th√°m">Trinh Th√°m</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tags (T·ª´ kh√≥a t√¨m ki·∫øm)</label>
                <input type="text" id="storyTagsInput" class="form-control" placeholder="Nh·∫≠p tag (VD: hethong, ngot) v√† nh·∫•n Enter...">
                <div id="tagsContainer" class="tags-container">
                    </div>
                <p style="color: #a1a1aa; font-size: 0.8rem; margin-top: 8px;">Nh·∫•n <b>Enter</b> ho·∫∑c d·∫•u ph·∫©y ( <b>,</b> ) ƒë·ªÉ th√™m tag.</p>
            </div>

            <div class="form-group">
                <label>M√¥ t·∫£ ng·∫Øn</label>
                <textarea id="storyDesc" class="form-control" rows="3" placeholder="Gi·ªõi thi·ªáu s∆° l∆∞·ª£c v·ªÅ n·ªôi dung..."></textarea>
            </div>
            
            <div class="form-group">
                <label>·∫¢nh b√¨a truy·ªán (T·ªâ l·ªá 2:3)</label>
                <div class="upload-area">
                    <img id="coverPreview" src="https://via.placeholder.com/200x300/222/555?text=Preview" class="preview-img">
                    <div class="upload-controls">
                        <div class="file-input-wrapper">
                            <div class="file-input-btn">
                                <i class="fas fa-upload"></i> Ch·ªçn ·∫£nh t·ª´ m√°y
                            </div>
                            <input type="file" id="storyCoverFile" accept="image/*">
                        </div>
                        <p style="color: #a1a1aa; font-size: 0.8rem; margin: 0;">Khuy√™n d√πng ·∫£nh JPG/PNG. Dung l∆∞·ª£ng < 2MB.</p>
                        <input type="hidden" id="oldCoverUrl">
                    </div>
                </div>
            </div>
            
            <input type="hidden" id="editStoryId">

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeCreateModal()">H·ªßy</button>
                <button id="btnSaveStory" class="btn-confirm-modal" onclick="handleFormSubmit()">L∆∞u L·∫°i</button>
            </div>
        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        // ƒê√£ x√≥a import Storage c·ªßa Firebase v√¨ kh√¥ng c·∫ßn d√πng n·ªØa

        // Config Firebase
        const firebaseConfig = { apiKey: "AIzaSyAT6SnKojUmsisDhnuEtsL3H59NwrhZxDc", authDomain: "hopphim-29e1c.firebaseapp.com", projectId: "hopphim-29e1c", storageBucket: "hopphim-29e1c.firebasestorage.app", messagingSenderId: "1076044580405", appId: "1:1076044580405:web:a3485f8533604f305e537c", measurementId: "G-6RT4CX2NR0" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let storiesCache = {}; 
        let currentTags = [];

        // HI·ªÇN TH·ªä NG√ÄY TH√ÅNG
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('vi-VN', options);

        // KI·ªÇM TRA ƒêƒÇNG NH·∫¨P
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('userName').innerText = user.displayName || "T√°c gi·∫£";
                document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=FF5E62&color=fff`;
                loadMyStories();
            } else {
                window.location.href = '/login.html';
            }
        });

        /* =========================================
           üî• LOGIC X·ª¨ L√ù HASHTAG 
           ========================================= */
        const tagsInput = document.getElementById('storyTagsInput');
        const tagsContainer = document.getElementById('tagsContainer');

        function renderTags() {
            tagsContainer.innerHTML = '';
            currentTags.forEach((tag, index) => {
                tagsContainer.innerHTML += `
                    <span class="tag-badge">
                        #${tag} <i class="fas fa-times" onclick="removeTag(${index})"></i>
                    </span>
                `;
            });
        }

        window.removeTag = (index) => {
            currentTags.splice(index, 1);
            renderTags();
        }

        tagsInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault(); 
                let tagStr = tagsInput.value.trim().replace(/^#/, ''); 
                if (tagStr !== '') {
                    let tagsArray = tagStr.split(',').map(t => t.trim().replace(/^#/, '')).filter(t => t !== '');
                    tagsArray.forEach(tag => {
                        if (!currentTags.includes(tag)) {
                            currentTags.push(tag);
                        }
                    });
                    renderTags(); 
                }
                tagsInput.value = ''; 
            }
        });

        /* =========================================
           üî• HI·ªÇN TH·ªä ·∫¢NH XEM TR∆Ø·ªöC V√Ä UPLOAD IMGBB üî•
           ========================================= */
        document.getElementById('storyCoverFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('coverPreview').src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // H√ÄM UPLOAD ·∫¢NH L√äN IMGBB (HO√ÄN TO√ÄN MI·ªÑN PH√ç)
        async function uploadImageToImgBB(file) {
            if (!file) return null;
            
            // üëá THAY API KEY C·ª¶A B·∫†N V√ÄO ƒê√ÇY üëá
            const IMGBB_API_KEY = "1488847e8e0c94e436037ff556736058"; 
            
            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.data.url; // Tr·∫£ v·ªÅ link ·∫£nh tr·ª±c ti·∫øp
                } else {
                    throw new Error("Kh√¥ng th·ªÉ t·∫£i ·∫£nh l√™n ImgBB");
                }
            } catch (error) {
                console.error("L·ªói up ·∫£nh:", error);
                throw error;
            }
        }

        // T·∫¢I DANH S√ÅCH TRUY·ªÜN
        async function loadMyStories() {
            const list = document.getElementById('storiesList');
            let totalStories = 0;
            let totalViews = 0;
            let totalChapters = 0;

            try {
                const q = query(collection(db, "stories"), where("authorId", "==", currentUserId));
                const querySnapshot = await getDocs(q);
                
                document.getElementById('loading').style.display = 'none';

                if (querySnapshot.empty) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-feather-alt empty-icon"></i>
                            <h3>Ch∆∞a c√≥ t√°c ph·∫©m n√†o</h3>
                            <p>H√£y b·∫Øt ƒë·∫ßu h√†nh tr√¨nh s√°ng t√°c c·ªßa b·∫°n ngay h√¥m nay.</p>
                        </div>`;
                } else {
                    list.innerHTML = '';
                    querySnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const id = docSnap.id;
                        
                        storiesCache[id] = data;

                        totalStories++;
                        totalViews += Number(data.views || 0);
                        totalChapters += Number(data.chapterCount || 0); 

                        const isPublished = data.status === 'Published';
                        const statusClass = isPublished ? 'status-published' : 'status-draft';
                        const statusText = isPublished ? 'ƒê√£ ho√†n th√†nh' : 'B·∫£n th·∫£o';
                        
                        const publishBtn = isPublished 
                            ? `<button class="btn-icon-text btn-unpublish" onclick="toggleStatus('${id}', 'Draft')"><i class="fas fa-eye-slash"></i> ·∫®n</button>`
                            : `<button class="btn-icon-text btn-publish" onclick="toggleStatus('${id}', 'Published')"><i class="fas fa-globe"></i> ƒêƒÉng</button>`;

                        list.innerHTML += `
                            <div class="story-card">
                                <img src="${data.cover}" class="card-poster" onerror="this.src='https://via.placeholder.com/150x225/222/555?text=Cover'">
                                <div class="card-body">
                                    <div>
                                        <div class="badge-group">
                                            <span class="card-status ${statusClass}">${statusText}</span>
                                            <span class="card-cat">${data.category || 'Kh√°c'}</span>
                                        </div>
                                        <div class="card-title" title="${data.title}">${data.title}</div>
                                        <div class="card-stats">
                                            <div class="stat-item"><i class="fas fa-layer-group"></i> ${data.chapterCount || 0} ch∆∞∆°ng</div>
                                            <div class="stat-item"><i class="fas fa-eye"></i> ${Number(data.views || 0).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="card-actions">
                                        <button class="btn-icon-text btn-write" onclick="window.location.href='write.html?id=${id}'">
                                            <i class="fas fa-pen-nib"></i> Vi·∫øt
                                        </button>
                                        
                                        <button class="btn-icon-text btn-edit" onclick="openEditModal('${id}')">
                                            <i class="fas fa-cog"></i> S·ª≠a
                                        </button>

                                        ${publishBtn}
                                        
                                        <button class="btn-icon-text btn-delete" onclick="deleteStory('${id}')">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                    });
                }
                
                animateValue("statTotal", 0, totalStories, 1000);
                animateValue("statViews", 0, totalViews, 1000);
                animateValue("statChapters", 0, totalChapters, 1000);

            } catch (e) { 
                console.error("L·ªói t·∫£i d·ªØ li·ªáu:", e);
            }
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if(!obj) return;
            if (end === 0) { obj.innerText = "0"; return; }
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                obj.innerText = value.toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- C√ÅC H√ÄM LI√äN QUAN ƒê·∫æN MODAL (T·∫†O & S·ª¨A) ---

        window.openCreateModal = () => {
            document.getElementById('editStoryId').value = ''; 
            document.getElementById('storyTitle').value = '';
            document.getElementById('storyDesc').value = '';
            document.getElementById('storyCategory').selectedIndex = 0;
            
            currentTags = [];
            renderTags();
            document.getElementById('storyTagsInput').value = '';

            document.getElementById('storyCoverFile').value = '';
            document.getElementById('oldCoverUrl').value = '';
            document.getElementById('coverPreview').src = 'https://via.placeholder.com/200x300/222/555?text=Preview';
            
            document.getElementById('btnSaveStory').innerText = "T·∫°o T√°c Ph·∫©m";
            document.querySelector('.modal-title').innerText = "T√°c ph·∫©m m·ªõi";
            
            document.getElementById('createModal').classList.add('active');
        };

        window.openEditModal = (id) => {
            const data = storiesCache[id];
            if(!data) return;

            document.getElementById('editStoryId').value = id;
            document.getElementById('storyTitle').value = data.title;
            document.getElementById('storyDesc').value = data.desc;
            document.getElementById('storyCategory').value = data.category;

            currentTags = data.tags || [];
            renderTags();
            document.getElementById('storyTagsInput').value = '';

            document.getElementById('storyCoverFile').value = ''; 
            document.getElementById('oldCoverUrl').value = data.cover || ''; 
            document.getElementById('coverPreview').src = data.cover || 'https://via.placeholder.com/200x300/222/555?text=Preview';

            document.getElementById('btnSaveStory').innerText = "L∆∞u Thay ƒê·ªïi";
            document.querySelector('.modal-title').innerText = "Ch·ªânh s·ª≠a th√¥ng tin";

            document.getElementById('createModal').classList.add('active');
        };

        window.closeCreateModal = () => document.getElementById('createModal').classList.remove('active');

        window.handleFormSubmit = async () => {
            const editId = document.getElementById('editStoryId').value;
            if (editId) {
                await updateStory(editId); 
            } else {
                await createNewStory();
            }
        }

        async function createNewStory() {
            const btn = document.getElementById('btnSaveStory');
            const title = document.getElementById('storyTitle').value.trim();
            const desc = document.getElementById('storyDesc').value.trim();
            const category = document.getElementById('storyCategory').value;
            
            const fileInput = document.getElementById('storyCoverFile');
            const file = fileInput.files[0];

            if(!title || !category) { showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß T√™n v√† Th·ªÉ lo·∫°i!", "error"); return; }

            btn.innerText = "ƒêang t·∫£i ·∫£nh & l∆∞u...";
            btn.disabled = true;

            try {
                let finalCoverUrl = "https://via.placeholder.com/400x600/222/555?text=No+Cover";
                if (file) {
                    finalCoverUrl = await uploadImageToImgBB(file); // G·ªçi API ImgBB
                }

                const docRef = await addDoc(collection(db, "stories"), {
                    title: title, 
                    desc: desc,
                    cover: finalCoverUrl, 
                    category: category,
                    tags: currentTags, 
                    authorId: currentUserId, 
                    authorName: auth.currentUser.displayName,
                    chapterCount: 0, 
                    views: 0, 
                    status: "Draft",
                    createdAt: serverTimestamp()
                });
                
                showToast("T·∫°o truy·ªán th√†nh c√¥ng!");
                window.location.href = `write.html?id=${docRef.id}`;
            } catch (e) { 
                showToast("L·ªói: " + e.message, "error");
                btn.innerText = "T·∫°o T√°c Ph·∫©m";
                btn.disabled = false;
            }
        }

        async function updateStory(id) {
            const btn = document.getElementById('btnSaveStory');
            const title = document.getElementById('storyTitle').value.trim();
            const desc = document.getElementById('storyDesc').value.trim();
            const category = document.getElementById('storyCategory').value;
            
            const fileInput = document.getElementById('storyCoverFile');
            const file = fileInput.files[0];
            const oldCover = document.getElementById('oldCoverUrl').value;

            if(!title || !category) { showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!", "error"); return; }

            btn.innerText = "ƒêang l∆∞u thay ƒë·ªïi...";
            btn.disabled = true;

            try {
                let finalCoverUrl = oldCover; 
                if (file) {
                    btn.innerText = "ƒêang t·∫£i ·∫£nh m·ªõi...";
                    finalCoverUrl = await uploadImageToImgBB(file); // G·ªçi API ImgBB
                }

                const storyRef = doc(db, "stories", id);
                await updateDoc(storyRef, {
                    title: title,
                    desc: desc,
                    cover: finalCoverUrl, 
                    category: category,
                    tags: currentTags 
                });

                showToast("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!");
                closeCreateModal();
                loadMyStories();
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                showToast("L·ªói c·∫≠p nh·∫≠t!", "error");
                btn.innerText = "L∆∞u Thay ƒê·ªïi";
                btn.disabled = false;
            }
        }

        window.toggleStatus = async (id, newStatus) => {
            try {
                const storyRef = doc(db, "stories", id);
                await updateDoc(storyRef, { status: newStatus });
                const msg = newStatus === 'Published' ? "ƒê√£ c√¥ng khai truy·ªán!" : "ƒê√£ g·ª° truy·ªán v·ªÅ b·∫£n th·∫£o.";
                showToast(msg, "success");
                loadMyStories(); 
            } catch (e) { showToast("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i.", "error"); }
        };

        window.deleteStory = async (id) => {
            if(confirm("X√≥a vƒ©nh vi·ªÖn truy·ªán n√†y? T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω m·∫•t h·∫øt.")) {
                try {
                    await deleteDoc(doc(db, "stories", id));
                    showToast("ƒê√£ x√≥a t√°c ph·∫©m.");
                    loadMyStories();
                } catch(e) { showToast("L·ªói khi x√≥a.", "error"); }
            }
        };

        window.showToast = (msg, type='success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'error' ? '#fb7185' : '#34d399';
            const icon = type === 'error' ? '<i class="fas fa-exclamation-circle" style="color:#fb7185"></i>' : '<i class="fas fa-check-circle" style="color:#34d399"></i>';
            toast.innerHTML = `${icon} ${msg}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        window.tryLogout = () => {
            if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) {
                signOut(auth).then(() => window.location.href = 'index.html').catch((e) => showToast("L·ªói ƒëƒÉng xu·∫•t", "error"));
            }
        }
    </script>
</body>
</html>